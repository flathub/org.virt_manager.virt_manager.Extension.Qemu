app-id: org.virt_manager.virt_manager.Extension.Qemu
runtime: org.virt_manager.virt-manager
runtime-version: stable
sdk: org.freedesktop.Sdk//24.08
build-extension: true
separate-locales: false
build-options:
  prefix: /app/lib/extensions/Qemu
  cflags: -I/app/lib/extensions/Qemu/include
  cxxflags: -I/app/lib/extensions/Qemu/include
  ldflags: -L/app/lib/extensions/Qemu/lib
  libdir: /app/lib/extensions/Qemu/lib
  prepend-path: /app/lib/extensions/Qemu/bin
  prepend-ld-library-path: /app/lib/extensions/Qemu/lib
  prepend-pkg-config-path: /app/lib/extensions/Qemu/lib/pkgconfig:/app/lib/extensions/Qemu/share/pkgconfig
  strip: true
cleanup:
  - "*.la"
  - "*.a"
  - /var
  - /include
  - /etc
  - /lib/pkgconfig
modules:
  - name: qemu
    build-options:
      env:
        PYTHONPATH: /app/lib/extensions/Qemu/lib/python3.12/site-packages:/usr/lib/python3.12/site-packages
    config-opts:
      # Flatpak currently does not have smartcard support https://github.com/flatpak/flatpak/issues/4723
      # - "--enable-smartcard"
      - --disable-bsd-user
      - --disable-debug-info
      - --disable-docs
      - --disable-download
      - --disable-glusterfs
      - --disable-linux-user
      - --disable-oss
      - --disable-user
      - --disable-werror
      - --disable-xen
      - --enable-kvm
      - --enable-opengl
      - --enable-slirp
      - --enable-spice
      - --enable-usb-redir
      - --enable-virglrenderer
      - --libexecdir=bin
      - --python=/bin/python3
      - --target-list=x86_64-softmmu,i386-softmmu
    post-install:
      - install -Dpm0644 ${FLATPAK_ID}.metainfo.xml -t ${FLATPAK_DEST}/share/metainfo
    sources:
      - type: archive
        url: https://download.qemu.org/qemu-10.1.0.tar.xz
        sha256: e0517349b50ca73ebec2fa85b06050d5c463ca65c738833bd8fc1f15f180be51
        x-checker-data:
          type: anitya
          project-id: 13607
          url-template: https://download.qemu.org/qemu-$version.tar.xz
      - type: file
        path: org.virt_manager.virt_manager.Extension.Qemu.metainfo.xml
    modules:
      - name: python3-distlib
        buildsystem: simple
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/96/8e/709914eb2b5749865801041647dc7f4e6d00b549cfe88b65ca192995f07c/distlib-0.4.0.tar.gz
            sha256: feec40075be03a04501a973d81f633735b4b69f98b05450592310c0f401a4e0d
            x-checker-data:
              type: pypi
              name: distlib
        build-commands:
          - pip3 install --global-option='--with-libyaml' --no-index --find-links="file://${PWD}"
            --prefix="${FLATPAK_DEST}" --no-build-isolation distlib
      - name: slirp
        buildsystem: meson
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/slirp/libslirp/-/archive/v4.9.1.tar.gz
            sha256: 9aef0c439abb5126f935ffec56be7da45a3dec7b8ba4a163d7ede74749f97d56
            x-checker-data:
              type: anitya
              project-id: 96796
              url-template: https://gitlab.freedesktop.org/slirp/libslirp/-/archive/v$version.tar.gz
      - name: usbredir
        buildsystem: meson
        modules:
          - shared-modules/libusb/libusb.json
        sources:
          - type: archive
            url: https://spice-space.org/download/usbredir/usbredir-0.15.0.tar.xz
            sha256: 6dc2a380277688a068191245dac2ab7063a552999d8ac3ad8e841c10ff050961
            x-checker-data:
              type: anitya
              project-id: 16012
              stable-only: true
              url-template: https://spice-space.org/download/usbredir/usbredir-$version.tar.xz
      - name: virglrenderer
        buildsystem: meson
        build-options:
          env:
            PYTHONPATH: /app/lib/extensions/Qemu/lib/python3.12/site-packages:/usr/lib/python3.12/site-packages
        config-opts:
          - -Dvideo=true
          - -Dvenus=true
          - -Dtests=false
        modules:
          - name: python3-PyYAML
            buildsystem: simple
            sources:
              - type: file
                url: https://files.pythonhosted.org/packages/05/8e/961c0007c59b8dd7729d542c61a4d537767a59645b82a0b521206e1e25c2/pyyaml-6.0.3.tar.gz
                sha256: d76623373421df22fb4cf8817020cbb7ef15c725b9d5e45f17e189bfc384190f
                x-checker-data:
                  type: pypi
                  name: pyyaml
            build-commands:
              - pip3 install --global-option='--with-libyaml' --no-index --find-links="file://${PWD}"
                --prefix="${FLATPAK_DEST}" --no-build-isolation PyYAML
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/virgl/virglrenderer/-/archive/1.2.0/virglrenderer-1.2.0.tar.gz
            sha256: 8bae92909021ea87e2087ae96df322f90140c414bd5f38810af3f3e5146a567b
            x-checker-data:
              type: anitya
              project-id: 15968
              url-template: https://gitlab.freedesktop.org/virgl/virglrenderer/-/archive/$version/virglrenderer-$version.tar.gz
      - name: spice
        buildsystem: autotools
        config-opts:
          - --disable-lz4
          - --disable-manual
          - --disable-test
        sources:
          - type: archive
            url: https://www.spice-space.org/download/releases/spice-0.16.0.tar.bz2
            sha256: 0a6ec9528f05371261bbb2d46ff35e7b5c45ff89bb975a99af95a5f20ff4717d
            x-checker-data:
              type: anitya
              project-id: 4871
              url-template: https://www.spice-space.org/download/releases/spice-$version.tar.bz2
        modules:
          - name: spice-protocol
            buildsystem: meson
            sources:
              - type: archive
                url: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v0.14.5/spice-protocol-v0.14.5.tar.gz
                sha256: 1be179b3dfbb23946432275f4b7a4b59bb5e9acc25c3128bc930b8264a9f0a20
                x-checker-data:
                  type: anitya
                  project-id: 14892
                  stable-only: true
                  url-template: https://gitlab.freedesktop.org/spice/spice-protocol/-/archive/v$version/spice-protocol-v$version.tar.gz
          - name: dtc
            buildsystem: meson
            sources:
              - type: archive
                url: https://git.kernel.org/pub/scm/utils/dtc/dtc.git/snapshot/v1.7.2.tar.gz
                sha256: 04a30bd38b426ed771b8a8b5d9b773e54976d4f5d51a80a9e76a45b20c9a8272
                x-checker-data:
                  type: anitya
                  project-id: 16911
                  url-template: https://git.kernel.org/pub/scm/utils/dtc/dtc.git/snapshot/v$version.tar.gz
  - name: swtpm
    buildsystem: autotools
    config-opts:
      - --with-gnutls
      - --with-tss-user=tss
      - --with-tss-group=tss
    cleanup:
      - /libexec/installed_tests
    sources:
      - type: archive
        url: https://github.com/stefanberger/swtpm/archive/refs/tags/v0.10.1.tar.gz
        sha256: f8da11cadfed27e26d26c5f58a7b8f2d14d684e691927348906b5891f525c684
        x-checker-data:
          type: anitya
          project-id: 116461
          stable-only: true
          url-template: https://github.com/stefanberger/swtpm/archive/refs/tags/v$version.tar.gz
      - type: patch
        path: swtpm-no-expect.patch
      - type: patch
        path: swtpm-tss-user.patch
    modules:
      - name: socat
        buildsystem: autotools
        sources:
          - type: archive
            url: http://www.dest-unreach.org/socat/download/socat-1.8.0.3.tar.gz
            sha256: a9f9eb6cfb9aa6b1b4b8fe260edbac3f2c743f294db1e362b932eb3feca37ba4
            x-checker-data:
              type: anitya
              project-id: 4848
              url-template: http://www.dest-unreach.org/socat/download/socat-$version.tar.gz
        cleanup:
          - /share
      - name: libtpms
        buildsystem: autotools
        sources:
          - type: archive
            url: https://github.com/stefanberger/libtpms/archive/refs/tags/v0.10.1.tar.gz
            sha256: ebc24f3191d90f6cf0b4d4200cd876db4bd224b3c565708bbea0a82ee275e0fb
            x-checker-data:
              type: anitya
              project-id: 116460
              stable-only: true
              url-template: https://github.com/stefanberger/libtpms/archive/refs/tags/v$version.tar.gz
        modules:
          - name: tcsd
            buildsystem: autotools
            config-opts:
              - --sbindir=${FLATPAK_DEST}/bin
            sources:
              - type: archive
                url: https://downloads.sourceforge.net/project/trousers/trousers/0.3.15/trousers-0.3.15.tar.gz
                sha256: 1e5be93e518372acf1d92d2f567d01a46fdb0b730487e544e6fb896c59cac77f
                x-checker-data:
                  type: anitya
                  project-id: 5400
                  url-template: https://downloads.sourceforge.net/project/trousers/trousers/$version/trousers-$version.tar.gz
          - name: netstat
            buildsystem: simple
            build-commands:
              # configure with default config
              - yes '' | make config
              - make netstat
              - install -m 0755 netstat ${FLATPAK_DEST}/bin
            sources:
              - type: archive
                url: https://sourceforge.net/projects/net-tools/files/net-tools-2.10.tar.xz
                sha256: b262435a5241e89bfa51c3cabd5133753952f7a7b7b93f32e08cb9d96f580d69
                x-checker-data:
                  type: anitya
                  project-id: 10231
                  stable-only: true
                  url-template: https://sourceforge.net/projects/net-tools/files/net-tools-$version.tar.xz
